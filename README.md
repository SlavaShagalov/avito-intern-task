# Avito Intern Task

### Описание

- Используется разделение на слои `delivery`, `usecase`, `repository` согласно чистой архитектуре.
- Реализованы `Middlewares` для: отслеживания паники, логирования, проверки админского доступа, проверки авторизации.
- Конфигурирование приложения с использованием `.yaml` файла.
- Сервис поднимается в `Docker` контейнерах: база данных, кэш и основное приложение.
- Контейнеры конфигурируются в  `docker-compose`.
- В качестве СУБД используется `PostgreSQL`.
- В качестве кэша используется `Redis`.
- Все методы имеют префикс `/api/v1`.
- Используется JWT-авторизация.
- Подключен `Github Actions` с джобами `lint`, `test` и `build`.
- Реализовал интеграционные тесты для всех методов.

### Makefile

В корне репозитория есть Makefile с командами проекта.
Бэкенд - порт 8000. БД - 5432. Кэш - 6379. Тестовая БД - 5435.

#### Поднять бэкенд, БД, кэш.

```shell
make up
```

#### Остановить сервер

```shell
make stop
```

#### Удалить все контейнеры вместе с volumes (удалить данные БД)

```shell
make down
```

#### Посмотреть логи бэкенда

```shell
make logs
```

#### Посмотреть логи другого контейнера, <SERVICE_NAME> - имя сервиса из docker-compose файла

```shell
make logs service=<SERVICE_NAME>
```

#### Запустить интеграционное тестирование

```shell
make test-integration
```

### API

Для всех запросов необходимо передавать заголовок авторизации, с ключом token.

1. Получение баннера для пользователя.

```bash
curl --location 'http://127.0.0.1:8000/api/v1/user_banner?tag_id=4&feature_id=1&use_last_revision=null' \
--header 'token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MTU2ODg4NDcsImlzX2FkbWluIjp0cnVlLCJ1c2VyX2lkIjoxfQ.BexsVzKwa1mmikyeIg6tddXr2tWCl3Aq82qUwS8M3yI'
```

#### Параметры запроса

- feature_id - id фичи
- tag_id - id тега
- use_last_revision(опциональный параметр) - при наличии параметра ответ берется напрямую из БД, в
  ином случае допускается передача информации, которая была актуальна 5 минут назад.

#### Ответ

**200 - OK**

```json
{
  "title": "some_title",
  "text": "some_text",
  "url": "some_url"
}
```

**401, 403, 404**

```text
Тело отсутствует
```

**400, 500**

```json
{
  "error": "string"
}
```

#### Описание кодов ответа

- 200 - OK;
- 400 - Некорректные данные;
- 401 - Пользователь не авторизован;
- 403 - Пользователь не имеет доступа;
- 404 - Баннер для не найден;
- 500 - ошибка сервера.

2. Получение всех баннеров c фильтрацией по фиче и/или тегу.

```bash
curl --location 'http://127.0.0.1:8000/api/v1/banner' \
--header 'token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MTU2ODk3OTQsImlzX2FkbWluIjp0cnVlLCJ1c2VyX2lkIjoxfQ.OWQsdIUuPd0K7MH2zfHDwtwkMpzYtLAXSJ3bcmlPM-Y'
```

#### Параметры запроса

- feature_id(опциональный параметр) - id фичи
- tag_id(опциональный параметр) - id тега
- limit(опциональный параметр) - ограничение размера ответа.
- offset(опциональный параметр) - смещение от начала списка баннеров в ответе.

#### Ответ

**200 - OK**

```json
[
  {
    "banner_id": 1,
    "tag_ids": [
      1
    ],
    "feature_id": 1,
    "content": {
      "title": "some_title",
      "text": "some_text",
      "url": "some_url"
    },
    "is_active": true,
    "created_at": "2024-04-14T12:32:01.024Z",
    "updated_at": "2024-04-14T12:32:01.024Z"
  }
]
```

**401, 403**

```text
Тело отсутствует
```

**500**

```json
{
  "error": "string"
}
```

#### Описание кодов ответа

- 200 - OK;
- 401 - Пользователь не авторизован;
- 403 - Пользователь не имеет доступа (не админ);
- 500 - ошибка сервера.

3. Создание нового баннера.

```bash
curl --location 'http://127.0.0.1:8000/api/v1/banner' \
--header 'token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MTMxNjU5ODQsImlzX2FkbWluIjp0cnVlLCJ1c2VyX2lkIjoxfQ.DxZ9qQW2ydo6gsH22EqEkkKavVntM2XJpsay9Wa1y5M' \
--header 'Content-Type: application/json' \
--data '{
  "tag_ids": [
    1, 2
  ],
  "feature_id": 4,
  "content": {
    "title_2": "some_title",
    "text_2": "some_text"
  },
  "is_active": false
}
'
```

#### Параметры запроса

Отсутствуют.

#### Ответ

**201 - Created**

```json
{
  "banner_id": 5
}
```

**401, 403**

```text
Тело отсутствует
```

**400, 500**

```json
{
  "error": "string"
}
```

#### Описание кодов ответа

- 201 - Created;
- 400 - Некорректные данные;
- 401 - Пользователь не авторизован;
- 403 - Пользователь не имеет доступа;
- 500 - ошибка сервера.

4. Обновление содержимого баннера.

```bash
curl --location --request PATCH 'http://127.0.0.1:8000/api/v1/banner/3' \
--header 'token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MTMzNDUyNjAsImlzX2FkbWluIjp0cnVlLCJ1c2VyX2lkIjoxfQ.pr9hSQEzDqTGEgcmqiSzFGvBGOhqZWMSDs73GNTWO7U' \
--header 'Content-Type: application/json' \
--data '{
  "tag_ids": [
    4, 5
  ],
  "feature_id": 4,
  "content": {
    "type": "123",
    "info": "data"
  },
  "is_active": false
}
'
```

#### Параметры запроса

- id - передается в пути, а не как гет-параметр, id баннера.

#### Ответ

**200, 401, 403, 404**

```text
Тело отсутствует
```

**400, 500**

```json
{
  "error": "string"
}
```

#### Описание кодов ответа

- 200 - OK;
- 400 - Некорректные данные;
- 401 - Пользователь не авторизован;
- 403 - Пользователь не имеет доступа;
- 404 - Баннер не найден;
- 500 - ошибка сервера.

5. Удаление баннера по идентификатору.

```bash
curl --location --request DELETE 'http://127.0.0.1:8000/api/v1/banner/3' \
--header 'token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MTMxNjU5ODQsImlzX2FkbWluIjp0cnVlLCJ1c2VyX2lkIjoxfQ.DxZ9qQW2ydo6gsH22EqEkkKavVntM2XJpsay9Wa1y5M'
```

#### Параметры запроса

- id - передается в пути, а не как гет-параметр, id баннера.

#### Ответ

**204, 401, 403, 404**

```text
Тело отсутствует
```

**400, 500**

```json
{
  "error": "string"
}
```

#### Описание кодов ответа

- 204 - OK;
- 400 - Некорректные данные;
- 401 - Пользователь не авторизован;
- 403 - Пользователь не имеет доступа;
- 404 - Баннер не найден;
- 500 - ошибка сервера.

### Дополнительные задания

- Провел нагрузочное тестирование полученного решения для запросов на чтение.
  Результаты и скрипты запуска тестирования [здесь](test/stress).
- Реализовал интеграционное тестирование для остальных сценариев [здесь](test/integration/banners_test.go).
- Описал конфигурацию [линтера](.golangci.yml).

### Проблемы, с которыми столкнулся

#### Обеспечение уникальности баннеров по фиче и тегу.

В условии сказано:

3. Фича и тег однозначно определяют баннер.

Придумал три варианта реализации схемы БД для этого:

1. Полностью нормализованная схема с использованием CHECK, который бы вызывал функцию проверки
   уникальности сочетания полей из разных таблиц.

2. Использование массива для хранения тегов баннера прямо в таблице баннеров. Тогда все равно
   нужно сделать какой-то CHECK, который проверяет уникальность между сочетаниями фичи и каждого
   тега из массива тегов для всех баннеров.

3. Денормализованная схема, в которой дублируется фича. Этот вариант **был выбран** в связи с легким
   созданием ограничения уникальности с помощью PRIMARY KEY (feature_id, tag_id).

#### Отдача кешированных ответов при неустановленном флаге use_last_revision.

Использовался алгоритм Lazy Cache, т.е. бэкенд пытается пойти
в кэш, если промах, то идет в БД, при этом обновляя кэш.
В создании ключа используются tag_id, feature_id, is_admin поля.
Кэшируются не только успешный ответ, но и ошибки.
